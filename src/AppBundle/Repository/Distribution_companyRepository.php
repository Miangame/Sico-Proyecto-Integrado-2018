<?php

namespace AppBundle\Repository;

/**
 * Distribution_companyRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class Distribution_companyRepository extends \Doctrine\ORM\EntityRepository
{
    public function getDistributionsCompanies()
    {

        return $this->getEntityManager()->createQuery("
                                      SELECT ds.id ,cp.name as company_name, CONCAT(us.first_name,' ',us.last_name) as user_name, CONCAT(st.first_name,' ',st.last_name) as student_name
                                      FROM AppBundle:Distribution_company ds,
                                      AppBundle:Company cp,AppBundle:Student st,
                                      AppBundle:User us 
                                      WHERE ds.user = us.id 
                                      AND ds.student = st.id 
                                      AND ds.company = cp.id")->getArrayResult();
    }

    public function getDistributionsCompaniesConvocatory($convocatory)
    {
        return $this->getEntityManager()->createQuery("
                                      SELECT ds.id ,cp.name as company_name, CONCAT(us.first_name,' ',us.last_name) as user_name, CONCAT(st.first_name,' ',st.last_name) as student_name
                                      FROM AppBundle:Distribution_company ds,
                                      AppBundle:Company cp,AppBundle:Student st,
                                      AppBundle:User us 
                                      WHERE ds.user = us.id 
                                      AND ds.student = st.id 
                                      AND ds.company = cp.id
                                      AND st.convocatory = ".intval($convocatory)." ")->getArrayResult();
    }


    public function getDistributionBYCompany($company, $convocatory)
    {
        $qb = $this->getEntityManager()->createQueryBuilder()
            ->select('st')
            ->from('AppBundle:Student', 'st')
            ->join('st.distribution_company', 'dp')
            ->join('dp.company', 'cp')
            ->where('cp.id = :company_id')
            ->andWhere('st.convocatory = :convocatory_id')
            ->setParameter('company_id', $company)
            ->setParameter('convocatory_id', $convocatory);

        return $qb->getQuery()->getResult();
    }

    public function getCompaniesTutor($tutor,$convocatory)
    {
        $qb = $this->getEntityManager()->createQueryBuilder()
            ->select('cp')
            ->from('AppBundle:Company', 'cp')
            ->join('cp.distribution_company', 'dc')
            ->join('dc.student', 'st')
            ->where('dc.user = :tutor')
            ->andWhere('st.convocatory = :convocatory_id')
            ->setParameter('convocatory_id', $convocatory)
            ->setParameter('tutor', $tutor);

        return $qb->getQuery()->getResult();
    }

    public function getAllForStudent($idStudent)
    {
        return $this->findBy(['student'=>$idStudent]);
    }




}
